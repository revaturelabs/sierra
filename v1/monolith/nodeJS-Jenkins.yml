AWSTemplateFormatVersion: '2010-09-09'

Parameters:
  ResourceBucket:
    Type: String
    Description: S3Bucket where resources are stored.
  FileName:
    Type: String
    Description: FileName of file containing environment variables
  KeyPair:
    Type: "AWS::EC2::KeyPair::KeyName"
    Description: Enter a valid KeyPair Name
  SSMParameter:
    Type: String
    Description: Name of the SSM Parameter store where environmental variables are stored
  SSHLocation:
    Description: The IP address range that can be used to SSH to the EC2 instances
    Type: String
    MinLength: '9'
    MaxLength: '18'
    Default: 0.0.0.0/0
    AllowedPattern: (\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})/(\d{1,2})
    ConstraintDescription: must be a valid IP CIDR range of the form x.x.x.x/x.

Mappings:
  RegionToImageId:
    us-east-1:
      ImageId: ami-008aabe2c694100ef
    us-east-2:
      ImageId: ami-08b3a274ee25fb2cd
    us-west-1: 
      ImageId: ami-01bac8138512a28dc
    us-west-2: 
      ImageId: ami-04254eff32682d423
    
Resources:
  JenkinsSecurityGroup: #Configure a security group
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupName: 'JenkinsSecurityGroup'
      GroupDescription: HTTP and SSH access only.
      SecurityGroupIngress: #Inbound Security configuration for the group
        - IpProtocol: tcp #SSH
          FromPort: '22'
          ToPort: '22'
          CidrIp: !Ref SSHLocation
        - IpProtocol: tcp #HTTP
          FromPort: '8080'
          ToPort: '8080'
          CidrIp: '0.0.0.0/0'
        - IpProtocol: tcp
          FromPort: '3000'
          ToPort: '3000'
          CidrIp: '0.0.0.0/0'
  JenkinsServer:
    Type: 'AWS::EC2::Instance'
    DependsOn: JenkinsSecurityGroup
    Properties:
      IamInstanceProfile: S3FullAccessRole
      ImageId: !FindInMap [RegionToImageId, !Ref 'AWS::Region', ImageId]
      InstanceType: t2.micro
      KeyName: 
        Ref: KeyPair
      SecurityGroups:
        - JenkinsSecurityGroup
      UserData: 
        Fn::Base64: |
         #!/bin/bash
          sudo su
          cd ~
          yum -y install git
          cd /
          wget https://s3.amazonaws.com/jenkins-template-sierra/config.xml
          cd /home/ec2-user/apache-tomcat-8.5.39/bin
          ./startup.sh
          cd /
          sleep 60
          cat config.xml | java -jar jenkins-cli.jar -s http://localhost:8080/jenkins/ -auth sierra:sierra create-job test2
          java -jar jenkins-cli.jar -s http://localhost:8080/jenkins/ -auth sierra:sierra build test2
          java -jar jenkins-cli.jar -s http://localhost:8080/jenkins/ -auth sierra:sierra build test2
      Tags:
        - Key: Name
          Value: Jenkins-NodeJS-Server

